<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zebra Print</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.container{background:#fff;padding:40px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-width:600px;width:100%}
h1{color:#333;margin-bottom:30px;font-size:32px;text-align:center}
button{width:100%;padding:18px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;margin:10px 0;transition:transform 0.2s}
button:hover{transform:translateY(-2px)}
button:disabled{background:#ccc;transform:none;cursor:not-allowed}
button.test{background:linear-gradient(135deg,#2196F3,#1976D2)}
button.print{background:linear-gradient(135deg,#4CAF50,#388E3C)}
input[type="file"]{width:100%;padding:15px;border:2px dashed #667eea;border-radius:10px;margin:10px 0;cursor:pointer;background:#f8f9ff}
input[type="text"]{width:100%;padding:15px;border:2px solid #667eea;border-radius:10px;margin:10px 0;font-size:14px}
.status{padding:15px;margin:20px 0;border-radius:10px;display:none;font-weight:500}
.status.show{display:block}
.success{background:#d4edda;color:#155724}
.error{background:#f8d7da;color:#721c24}
.info{background:#d1ecf1;color:#0c5460}
.divider{text-align:center;margin:20px 0;color:#999;font-weight:600}
</style>
</head>
<body>
<div class="container">
<h1>üñ®Ô∏è Zebra Print</h1>
<button onclick="testConnection()" class="test">üîå Test Raspberry Pi</button>

<div class="divider">‚Äî NAHRAJ SOUBOR ‚Äî</div>
<input type="file" id="fileInput" accept=".pdf" onchange="handleFile(this.files[0])">
<button id="printBtn" onclick="printPDF()" disabled class="print">üñ®Ô∏è Vytisknout soubor</button>

<div class="divider">‚Äî NEBO VLO≈Ω ODKAZ ‚Äî</div>
<input type="text" id="urlInput" placeholder="https://go-balik.cz/...stiket.pdf" onpaste="handlePaste()">
<button id="printUrlBtn" onclick="printFromURL()" disabled class="print">üñ®Ô∏è Vytisknout z odkazu</button>

<div id="status" class="status"></div>
</div>
<script>
const RPI_URL = 'https://10.0.0.160:8090';
let selectedFile = null;

// Automatick√© zpracov√°n√≠ URL z parametru (pro propojen√≠ s GoBal√≠k)
window.addEventListener('DOMContentLoaded', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const pdfUrl = urlParams.get('pdf_url');
  
  if (pdfUrl) {
    document.getElementById('urlInput').value = decodeURIComponent(pdfUrl);
    document.getElementById('printUrlBtn').disabled = false;
    showStatus('üîó Odkaz naƒçten z GoBal√≠ku', 'info');
    
    // Automaticky vytiskni po 1 sekundƒõ
    setTimeout(() => {
      printFromURL(true);
    }, 1000);
  }
});

function showStatus(message, type) {
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = 'status show ' + type;
}

async function testConnection() {
  showStatus('‚è≥ Testuji spojen√≠...', 'info');
  try {
    const response = await fetch(RPI_URL + '/status');
    if (response.ok) {
      const data = await response.json();
      showStatus('‚úÖ P≈ôipojeno: ' + data.printer, 'success');
    } else {
      throw new Error('HTTP ' + response.status);
    }
  } catch (error) {
    showStatus('‚ùå Chyba: ' + error.message, 'error');
  }
}

function handleFile(file) {
  if (!file || file.type !== 'application/pdf') {
    showStatus('‚ö†Ô∏è Pros√≠m nahraj pouze PDF soubor!', 'error');
    return;
  }
  selectedFile = file;
  showStatus('‚úÖ P≈ôipraveno: ' + file.name + ' (' + (file.size/1024).toFixed(2) + ' KB)', 'success');
  document.getElementById('printBtn').disabled = false;
}

function handlePaste() {
  setTimeout(() => {
    const url = document.getElementById('urlInput').value.trim();
    document.getElementById('printUrlBtn').disabled = !url;
  }, 100);
}

async function printPDF() {
  if (!selectedFile) return;
  
  const btn = document.getElementById('printBtn');
  btn.disabled = true;
  showStatus('üì§ Odes√≠l√°m na tisk√°rnu...', 'info');
  
  try {
    const arrayBuffer = await selectedFile.arrayBuffer();
    const formData = new FormData();
    formData.append('file', new Blob([arrayBuffer], {type: 'application/pdf'}), selectedFile.name);
    
    const response = await fetch(RPI_URL + '/print', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      showStatus('‚úÖ Vyti≈°tƒõno na Zebra ZD230!', 'success');
      selectedFile = null;
      document.getElementById('fileInput').value = '';
      btn.disabled = true;
    } else {
      throw new Error('HTTP ' + response.status);
    }
  } catch (error) {
    showStatus('‚ùå Chyba: ' + error.message, 'error');
    btn.disabled = false;
  }
}

async function printFromURL(autoMode = false) {
  const urlInput = document.getElementById('urlInput');
  const url = urlInput.value.trim();
  
  if (!url) {
    showStatus('‚ö†Ô∏è Pros√≠m vlo≈æ platn√Ω odkaz na PDF!', 'error');
    return;
  }
  
  const btn = document.getElementById('printUrlBtn');
  btn.disabled = true;
  showStatus('üì• Stahuji PDF z odkazu...', 'info');
  
  try {
    // St√°hneme PDF z URL (p≈ôes CORS proxy, pokud je pot≈ôeba)
    let pdfResponse;
    try {
      pdfResponse = await fetch(url);
    } catch (corsError) {
      // Pokud CORS blokuje, zkus√≠me proxy
      showStatus('üîÑ Pou≈æ√≠v√°m CORS proxy...', 'info');
      pdfResponse = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url));
    }
    
    if (!pdfResponse.ok) {
      throw new Error('Nelze st√°hnout PDF (HTTP ' + pdfResponse.status + ')');
    }
    
    const arrayBuffer = await pdfResponse.arrayBuffer();
    const fileName = url.split('/').pop().split('?')[0] || 'stiket.pdf';
    
    showStatus('üì§ Odes√≠l√°m na tisk√°rnu...', 'info');
    
    const formData = new FormData();
    formData.append('file', new Blob([arrayBuffer], {type: 'application/pdf'}), fileName);
    
    const response = await fetch(RPI_URL + '/print', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      showStatus('‚úÖ Vyti≈°tƒõno na Zebra ZD230!', 'success');
      urlInput.value = '';
      btn.disabled = true;
      
      // Pokud jsme v auto-re≈æimu (z GoBal√≠ku), zav≈ôeme okno po 3 sekund√°ch
      if (autoMode) {
        setTimeout(() => {
          window.close();
        }, 3000);
      }
    } else {
      throw new Error('HTTP ' + response.status);
    }
  } catch (error) {
    showStatus('‚ùå Chyba: ' + error.message, 'error');
    btn.disabled = false;
  }
}

// Poslouchej na URL zmƒõny v inputu
document.getElementById('urlInput').addEventListener('input', function() {
  document.getElementById('printUrlBtn').disabled = !this.value.trim();
});
</script>
</body>
</html>
